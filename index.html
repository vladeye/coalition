<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>

    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://w2ui.com/src/w2ui-1.5.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://w2ui.com/src/w2ui.min.css" />

</head>
<body style="visibility: visible !important;">
    <div  class="form-horizontal" style="visibility: visible !important;">
        <fieldset>
            <legend>Coalition PHP/javascript Test</legend>
            <div class="control-group">
                <label class="control-label" for="product_name">Product name</label>
                <div class="controls">
                    <input type="text" class="input-xlarge required" id="product_name">
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="quantity_in_stock">Quantity in stock:</label>
                <div class="controls">
                    <input type="text" class="input-xlarge required" id="quantity_in_stock">
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="price_per_item">Price per item:</label>
                <div class="controls">
                    <input type="text" class="input-xlarge required" id="price_per_item">
                </div>
            </div>

            <div class="form-actions">
                <input id="save-inventory" type="button" class="btn btn-primary" value="Save" name="save"></input>
                <input id="reset-inventory" type="button" class="btn" value="Reset" name="reset"></input>
            </div>
        </fieldset>
    </div>
    <!--/form-->

    <div id="gridInventory" style="width: 100%; height: 400px;"></div>

</body>
<script>
    function defaulttextRemove(){
        $('.required').each(function(){
            var defaultVal = $(this).attr('title');
            //if ($(this).val() == defaultVal){
            $(this).val('');
            //}
        });
    }
    $('#save-inventory')
        .on('click', (e) => {
            e.preventDefault();

            //defaulttextRemove();
            $('.controls').removeClass('error');
            $('span.error').remove();
            $('.required').each(function(){
                var inputVal = $(this).val();
                var $parentTag = $(this).parent();
                if(inputVal == '') {
                    $parentTag.addClass('error').append('<span class="error">Required field</span>');
                }
            });
            if ($('span.error').length == "0") {
                console.log("with no error");
                let formData = {
                    product_name: $("#product_name").val(),
                    quantity_in_stock: $("#quantity_in_stock").val(),
                    price_per_item: $("#price_per_item").val(),
                };

                $.ajax({
                    type: "POST",
                    url: "http://localhost:8000/inventory",
                    data: JSON.stringify(formData),
                    dataType: "json",
                    encode: true,
                }).done((data) => {
                    w2ui['gridInventory'].load('http://localhost:8000/inventory');
                    alert('Item added successfully');
                    console.log(data);
                });
            }
        });
    $('#reset-inventory')
        .on('click', (e) => {
            e.preventDefault();
            defaulttextRemove();
        });

    $(function () {

        $('#gridInventory').w2grid({
            name: 'gridInventory',
            header: '<label style="color: #2e6da4; font-weight: bold; ">Inventory</label>',
            show: {      // config grid toolbar, header and footer
                toolbar: true,
                header: true,
                footer: false,
                toolbarAdd: false,
                toolbarDelete: false,
                toolbarEdit: false
            },
            method: 'GET', // need this to avoid 412 error on Safari
            searches: [
                { field: 'product_name', text: 'Product name', type: 'text' },
                { field: 'quantity_in_stock', text: 'Quantity in stock', type: 'text' },
                { field: 'price_per_item', text: 'Price per item', type: 'text' },
                { field: 'created_at', text: 'Created At', type: 'date' },
                { field: 'total_value_number', text: 'Total value number', type: 'number' }
            ],
            columns: [
                { field: 'product_name', text: 'Product name', size: '30%', sortable: true, editable: { type: 'text' } },
                { field: 'quantity_in_stock', text: 'Quantity in stock', size: '20%', sortable: true, editable: { type: 'text' } },
                { field: 'price_per_item', text: 'Price per item', size: '20%', sortable: true, editable: { type: 'text' } },
                { field: 'created_at', text: 'Created At', size: '20%', sortable: true },
                { field: 'total_value_number', text: 'Total value number', size: '20%', sortable: true  }
            ],
            onChange: function(event) {
                event.onComplete = () => {
                    var record = w2ui.gridInventory.get(event['recid']);
                    const updateData = {};
                    updateData["recid"] = record["recid"];
                    updateData["product_name"] = record["product_name"];
                    updateData["quantity_in_stock"] = record["quantity_in_stock"];
                    updateData["price_per_item"] = record["price_per_item"];
                    const key = Object.keys(record["w2ui"]["changes"])[0];
                    updateData[key] = record["w2ui"]["changes"][key];
                    console.log(JSON.stringify(updateData));
                    $.ajax({
                        type: "PUT",
                        url: "http://localhost:8000/inventory",
                        data: JSON.stringify(updateData),
                        dataType: "json",
                        encode: true
                    }).done((data) => {
                        alert('Item updated successfully');
                        console.log("PUT");
                    });
                }
            },
            onLoad: (event) => {
                console.log('onload');

                event.onComplete = function () {
                    let totalValue = 0;
                    for(let i = 0; i < w2ui.gridInventory.records.length; i++){
                        totalValue += parseFloat(w2ui.gridInventory.records[i]['total_value_number']);
                    }
                    const newRecord = {
                        w2ui: {summary: true},
                        product_name: '',
                        quantity_in_stock: '',
                        price_per_item: '',
                        created_at: '<span style="float: right;font-weight: bold">Total</span>',
                        total_value_number: totalValue
                    };
                    w2ui.gridInventory.add($.extend(true, {recid: w2ui.gridInventory.records.length + 1}, newRecord));
                }
            },
        });
        w2ui['gridInventory'].load('http://localhost:8000/inventory');

    });


</script>
</html>